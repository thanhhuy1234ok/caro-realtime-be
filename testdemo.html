<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Caro Real-time</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    #board {
      display: grid;
      grid-template-columns: repeat(20, 30px);
      margin-top: 20px;
    }
    .cell {
      width: 30px; height: 30px; border: 1px solid #ccc;
      display: flex; justify-content: center; align-items: center;
      font-size: 16px; cursor: pointer;
    }
    .room-entry {
      margin: 4px 0;
    }
  </style>
</head>
<body>

<h2>üéÆ Game Caro Real-time</h2>

<input id="username" placeholder="T√™n ng∆∞·ªùi ch∆°i" />
<button onclick="createRoom()">T·∫°o ph√≤ng</button>

<input id="roomInput" placeholder="Nh·∫≠p m√£ ph√≤ng" />
<button onclick="joinRoom()">V√†o ph√≤ng</button>

<button onclick="getAvailableRooms()">üîç Danh s√°ch ph√≤ng c√≥ s·∫µn</button>

<h3 id="roomInfo"></h3>
<div id="roomsList"></div>

<div id="board"></div>

<script>
  const socket = io("http://localhost:8080");

  let mySymbol = "";
  let currentTurn = "X";
  let roomId = "";

  function createBoard() {
    const board = document.getElementById("board");
    board.innerHTML = "";
    for (let y = 0; y < 20; y++) {
      for (let x = 0; x < 20; x++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.dataset.x = x;
        cell.dataset.y = y;
        cell.onclick = () => makeMove(x, y);
        board.appendChild(cell);
      }
    }
  }

  function createRoom() {
    const username = document.getElementById("username").value;
    if (!username) return alert("H√£y nh·∫≠p t√™n ng∆∞·ªùi ch∆°i!");
    socket.emit("createRoom", { username }, (res) => {
      if (res.success) {
        roomId = res.roomId;
        document.getElementById("roomInfo").innerText = `ƒê√£ t·∫°o ph√≤ng: ${roomId}`;
        createBoard();
      }
    });
  }

  function joinRoom() {
    const username = document.getElementById("username").value;
    const inputRoomId = document.getElementById("roomInput").value;
    if (!username || !inputRoomId) return alert("ƒêi·ªÅn ƒë·ªß t√™n v√† m√£ ph√≤ng!");
    socket.emit("joinRoom", { roomId: inputRoomId, username }, (res) => {
      if (res.success) {
        roomId = inputRoomId;
        document.getElementById("roomInfo").innerText = `ƒê√£ v√†o ph√≤ng: ${roomId}`;
        createBoard();
      } else {
        alert(res.message);
      }
    });
  }

  function getAvailableRooms() {
    socket.emit("getAvailableRooms");
  }

  function makeMove(x, y) {
    if (mySymbol !== currentTurn) {
      alert("Ch∆∞a ƒë·∫øn l∆∞·ª£t b·∫°n!");
      return;
    }
    const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
    if (cell.textContent) return;
    socket.emit("makeMove", { roomId, x, y, symbol: mySymbol });
  }

  // üéØ Socket Events
  socket.on("assignSymbol", (symbol) => {
    mySymbol = symbol;
    alert(`B·∫°n l√† ng∆∞·ªùi ch∆°i: ${symbol}`);
  });

  socket.on("moveMade", ({ x, y, symbol }) => {
    const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
    if (cell) cell.textContent = symbol;
    currentTurn = symbol === "X" ? "O" : "X";
  });

  socket.on("gameOver", ({ winner, username }) => {
    setTimeout(() => {
      alert(`üéâ Ng∆∞·ªùi th·∫Øng l√† ${username} (${winner})`);
    }, 100);
  });

  socket.on("playerJoined", (players) => {
    const info = players.map(p => `${p.username} (${p.symbol})`).join(" vs ");
    document.getElementById("roomInfo").innerText = `Ph√≤ng: ${roomId} | ${info}`;
  });

  socket.on("playerLeft", () => {
    alert("‚ö†Ô∏è Ng∆∞·ªùi ch∆°i ƒë√£ r·ªùi ph√≤ng.");
  });

  socket.on("availableRooms", (rooms) => {
    const roomsList = document.getElementById("roomsList");
    roomsList.innerHTML = "<h4>Ph√≤ng ƒëang m·ªü:</h4>";
    if (rooms.length === 0) {
      roomsList.innerHTML += "<p>Kh√¥ng c√≥ ph√≤ng n√†o m·ªü</p>";
      return;
    }
    rooms.forEach((room) => {
      const div = document.createElement("div");
      div.className = "room-entry";
      div.innerHTML = `Ph√≤ng: <b>${room.roomId}</b> | Ng∆∞·ªùi: ${room.players.join(", ")} 
        <button onclick="quickJoin('${room.roomId}')">Tham gia</button>`;
      roomsList.appendChild(div);
    });
  });

  function quickJoin(id) {
    document.getElementById("roomInput").value = id;
    joinRoom();
  }
</script>

</body>
</html>
